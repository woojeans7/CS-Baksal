# TCP 3 Way Handshake & 4 Way Handshake

TCP는 신뢰성을 보장하는 특징이 있다.
두 애플리케이션에서 송신자와 수신자 간에 신뢰성 있는 통신을 하기 위해 3 Way Handshake로 연결을 수립하고, 4 Way Handshake로 연결을 종료한다.
즉, 연결을 성립하고 해체하는 과정을 의미한다.

TCP Header에서 Control(Flag) 영역을 들여다보면 여러 플래그가 존재하는데 이 플래그들을 통해서 3 Way Handshake와 4 Way Handshake가 동작하게 된다.

![[무제.gif]]

### TCP 플래그

- **SYN** : 연결의 시작 용도
- **ACK** : ACK 번호가 유효할 경우 1을 응답
- **FIN** : 데이터 전송을 마친 후 정상적으로 양방향 종료 시 사용. 연결 종료 시 1
- RST : 연결 강제 종료를 위해 일방적으로 끊을 때 사용. 연결 종료 시 1
- URG : 긴급 데이터인 경우 1
- PSH : 서버 측에서 전송할 데이터가 없거나 데이터를 버퍼링 없이 애플리케이션으로 즉시 전달할 것을 지시할 때 사용

## 3 Way Handshake

3 way handshake(3방향 핸드셰이크)는 <mark style="background: #FFF3A3A6;">ACK, SYN</mark> 플래그를 이용해서 **연결을 수립**한다.

![[Pasted image 20251104205835.png]]

연결 수립을 위한 3단계 과정

1. **SYN** : 클라이언트 → 서버

   - 클라이언트가 서버에 연결 요청
   - SYN 플래그 설정, 초기 시퀀스 넘버(ISN) 전송

2. **SYN + ACK** : 서버 → 클라이언트

   - 서버가 요청 수락
   - SYN + ACK 플래그 설정
   - 서버의 ISN 전송 + 클라이언트 ISN+1 확인

3. **ACK** : 클라이언트 → 서버
   - 클라이언트가 수락 확인
   - ACK 플래그 설정, 서버 ISN+1 확인
   - 이후 데이터 전송 가능

여담 : 두 프로그램 사이의 쓰리쿠션 악수라고 생각하면 된다.

### 2way가 아닌 3way인 이유

- 2-Way: 서버의 응답을 클라이언트가 받았는지 확인 불가
- 3-Way: 양방향 통신 채널이 모두 열렸음을 보장

## 4 Way HandShake

4 way handshake(4방향 핸드셰이크)는 **연결을 종료**하기 위한 과정으로 <mark style="background: #FFF3A3A6;">ACK, FIN</mark> 플래그를 사용한다.

![[Pasted image 20251104211111.png]]

연결 종료를 위한 4단계 과정

1. **FIN**: 클라이언트 → 서버

   - 클라이언트가 연결 종료 요청

2. **ACK**: 서버 → 클라이언트

   - 서버가 종료 요청 확인
   - 아직 전송할 데이터가 있을 수 있음

3. **FIN**: 서버 → 클라이언트

   - 서버가 데이터 전송 완료 후 종료 준비 완료

4. **ACK**: 클라이언트 → 서버
   - 클라이언트가 종료 확인
   - TIME_WAIT 상태 후 연결 완전 종료

### 왜 4-Way인가?

- 서버가 FIN을 받아도 전송 중인 데이터가 있을 수 있음
- 양방향으로 각각 종료 절차 필요 (FIN + ACK × 2)
